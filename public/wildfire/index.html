<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Wildfire Occurrences — AGCP Farmacéuticos</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #080c14; color: #e8e8f0; font-family: 'DM Sans', sans-serif;
    min-height: 100vh; overflow-x: hidden;
  }
  .glow-bg {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;
    background: radial-gradient(ellipse at 50% 40%, rgba(180,58,0,0.07) 0%, transparent 60%);
  }

  /* ─── AGCP TOP BAR ─────────────────────────────────────────── */
  .agcp-bar {
    background: linear-gradient(135deg, #0d1a2e 0%, #122240 100%);
    border-bottom: 1px solid rgba(0,164,132,0.25);
    padding: 14px 32px;
    display: flex; align-items: center; justify-content: space-between;
    position: relative; z-index: 10;
  }
  .agcp-brand {
    display: flex; align-items: center; gap: 14px;
  }
  .agcp-logo-mark {
    width: 38px; height: 38px; border-radius: 8px;
    background: linear-gradient(135deg, #00a484, #007a63);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Space Mono', monospace; font-weight: 700; font-size: 14px;
    color: #fff; letter-spacing: 1px;
    box-shadow: 0 2px 12px rgba(0,164,132,0.3);
  }
  .agcp-name {
    font-weight: 700; font-size: 16px; color: #fff; letter-spacing: 0.5px;
  }
  .agcp-name span {
    font-weight: 400; font-size: 12px; color: rgba(255,255,255,0.5);
    display: block; margin-top: 1px;
  }
  .agcp-tagline {
    font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: 2px;
    color: rgba(0,164,132,0.7); text-transform: uppercase;
  }

  /* ─── MAIN STYLES ──────────────────────────────────────────── */
  header { padding: 24px 32px 0; position: relative; z-index: 2; }
  .header-row { display: flex; align-items: flex-end; gap: 16px; flex-wrap: wrap; }
  .subtitle {
    font-family: 'Space Mono', monospace; font-size: 11px; letter-spacing: 3px;
    color: #00a484; text-transform: uppercase; margin-bottom: 6px; font-weight: 700;
  }
  h1 {
    font-size: 28px; font-weight: 700; margin: 0; line-height: 1.1;
    background: linear-gradient(135deg, #fff3b0, #f5b942, #e8751a);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .controls { margin-left: auto; display: flex; gap: 8px; }
  .metric-btn {
    padding: 8px 16px; border-radius: 6px; border: 1px solid #253350;
    background: rgba(255,255,255,0.03); color: #888;
    font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.2s;
  }
  .metric-btn.active {
    border-color: #00a484; background: rgba(0,164,132,0.12); color: #00d4a8;
  }
  .stats-row { display: flex; gap: 32px; margin-top: 16px; flex-wrap: wrap; }
  .stat-label {
    font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: 2px;
    color: #556; text-transform: uppercase; margin-bottom: 2px;
  }
  .stat-value { font-size: 22px; font-weight: 700; color: #f5b942; }
  .main-content { display: flex; gap: 0; padding: 16px 0 0; position: relative; z-index: 1; }
  .map-container { flex: 1; position: relative; min-width: 0; }
  .map-container svg { width: 100%; height: auto; display: block; }
  .country-path { transition: fill 0.3s, stroke 0.15s; }
  .country-path.has-data { cursor: pointer; }
  .country-path.has-data:hover { filter: brightness(1.3); }

  .tooltip {
    position: absolute; background: rgba(8,12,20,0.96); border: 1px solid rgba(0,164,132,0.35);
    border-radius: 8px; padding: 12px 16px; pointer-events: none; z-index: 10;
    min-width: 200px; backdrop-filter: blur(8px); box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    display: none;
  }
  .tooltip.visible { display: block; }
  .tooltip-name { font-weight: 700; font-size: 15px; color: #f5b942; margin-bottom: 8px; }
  .tooltip-grid { display: grid; grid-template-columns: auto auto; gap: 4px 16px; font-size: 12px; }
  .tooltip-grid .label { color: #778; }
  .tooltip-grid .val { font-weight: 600; text-align: right; }

  .legend {
    position: absolute; bottom: 20px; left: 32px; display: flex; align-items: center; gap: 4px;
  }
  .legend-label {
    font-size: 10px; color: #556; margin-right: 4px; font-family: 'Space Mono', monospace;
  }
  .legend-bar { display: flex; height: 10px; border-radius: 3px; overflow: hidden; }
  .legend-bar div { width: 4px; height: 10px; }
  .legend-range { font-size: 9px; color: #556; font-family: 'Space Mono', monospace; margin-left: 4px; }

  .sidebar {
    width: 260px; padding: 0 24px 24px 8px; flex-shrink: 0;
    max-height: 500px; overflow-y: auto;
  }
  .sidebar::-webkit-scrollbar { width: 4px; }
  .sidebar::-webkit-scrollbar-track { background: transparent; }
  .sidebar::-webkit-scrollbar-thumb { background: #253350; border-radius: 2px; }
  .sidebar-title {
    font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: 2px;
    color: #556; text-transform: uppercase; margin-bottom: 12px;
  }
  .rank-item {
    padding: 8px 10px; margin-bottom: 2px; border-radius: 6px;
    border: 1px solid transparent; cursor: pointer; transition: all 0.2s;
    position: relative; overflow: hidden;
  }
  .rank-item.selected { background: rgba(0,164,132,0.08); border-color: rgba(0,164,132,0.2); }
  .rank-bar {
    position: absolute; left: 0; top: 0; bottom: 0;
    background: rgba(245,185,66,0.04); transition: width 0.4s ease;
  }
  .rank-content { display: flex; justify-content: space-between; align-items: center; position: relative; }
  .rank-num { font-family: 'Space Mono', monospace; font-size: 10px; color: #445; width: 18px; text-align: right; }
  .rank-name { font-size: 12px; font-weight: 500; color: #ccc; margin-left: 8px; }
  .rank-val { font-size: 11px; font-weight: 700; color: #f5b942; font-family: 'Space Mono', monospace; }

  .detail-card {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    background: rgba(8,12,20,0.96); border: 1px solid rgba(0,164,132,0.25);
    border-radius: 12px; padding: 16px 28px; z-index: 20; backdrop-filter: blur(12px);
    box-shadow: 0 12px 48px rgba(0,0,0,0.7); display: none; gap: 32px; align-items: center;
  }
  .detail-card.visible { display: flex; }
  .detail-name { font-size: 18px; font-weight: 700; color: #f5b942; }
  .detail-peak { font-size: 11px; color: #778; margin-top: 2px; }
  .detail-sep { height: 40px; width: 1px; background: #253350; }
  .detail-metric { text-align: center; }
  .detail-metric-label { font-size: 9px; color: #556; text-transform: uppercase; font-family: 'Space Mono', monospace; letter-spacing: 1px; }
  .detail-metric-val { font-size: 18px; font-weight: 700; color: #e8751a; }
  .close-btn {
    background: none; border: 1px solid #253350; color: #778; border-radius: 6px;
    padding: 4px 10px; cursor: pointer; font-size: 12px; font-family: 'DM Sans', sans-serif; margin-left: 8px;
  }

  /* ─── AGCP FOOTER ──────────────────────────────────────────── */
  .footer {
    padding: 20px 32px 12px; font-size: 10px; color: #445;
    font-family: 'Space Mono', monospace; line-height: 1.6;
    border-top: 1px solid rgba(0,164,132,0.12); margin-top: 8px;
  }
  .footer-grid {
    display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 16px;
  }
  .footer-sources { max-width: 620px; }
  .footer-prepared {
    text-align: right; color: #667;
  }
  .footer-prepared .prep-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: #445; margin-bottom: 4px; }
  .footer-prepared .prep-company { font-size: 13px; color: #00a484; font-weight: 700; letter-spacing: 0.5px; }
  .footer-prepared .prep-sub { font-size: 10px; color: #556; margin-top: 2px; }
  .footer-legal {
    width: 100%; padding-top: 12px; margin-top: 12px;
    border-top: 1px solid rgba(255,255,255,0.04);
    font-size: 9px; color: #334; text-align: center;
  }

  @media (max-width: 768px) {
    .main-content { flex-direction: column; }
    .sidebar { width: 100%; max-height: 300px; padding: 16px 24px; }
    .detail-card { flex-wrap: wrap; gap: 16px; padding: 12px 20px; }
    h1 { font-size: 22px; }
    .controls { margin-left: 0; margin-top: 8px; }
    .agcp-bar { flex-direction: column; gap: 8px; align-items: flex-start; }
  }
</style>
</head>
<body>

<div class="glow-bg"></div>

<!-- AGCP Branded Top Bar -->
<div class="agcp-bar">
  <div class="agcp-brand">
    <div class="agcp-logo-mark">AGCP</div>
    <div class="agcp-name">
      AGCP Farmacéuticos, LDA
      <span>Advanced Materials Platform</span>
    </div>
  </div>
  <div class="agcp-tagline">Environmental Intelligence Report</div>
</div>

<header>
  <div class="header-row">
    <div>
      <div class="subtitle">GWIS / MODIS MCD64A1 — Global Analysis</div>
      <h1>Global Wildfire Occurrences</h1>
    </div>
    <div class="controls">
      <button class="metric-btn active" data-metric="burned_ha" onclick="setMetric('burned_ha')">Burned Area</button>
      <button class="metric-btn" data-metric="events_est" onclick="setMetric('events_est')">Fire Events</button>
    </div>
  </div>
  <div class="stats-row" id="statsRow"></div>
</header>

<div class="main-content">
  <div class="map-container" id="mapContainer">
    <svg id="mapSvg" viewBox="0 0 960 500"></svg>
    <div class="tooltip" id="tooltip">
      <div class="tooltip-name" id="tipName"></div>
      <div class="tooltip-grid">
        <span class="label">Burned Area</span><span class="val" id="tipBurned"></span>
        <span class="label">Est. Events</span><span class="val" id="tipEvents"></span>
        <span class="label">Peak Season</span><span class="val" id="tipPeak"></span>
      </div>
    </div>
    <div class="legend" id="legend"></div>
  </div>
  <div class="sidebar">
    <div class="sidebar-title" id="sidebarTitle">Top 15 by Burned Area</div>
    <div id="rankList"></div>
  </div>
</div>

<div class="detail-card" id="detailCard">
  <div>
    <div class="detail-name" id="detailName"></div>
    <div class="detail-peak" id="detailPeak"></div>
  </div>
  <div class="detail-sep"></div>
  <div class="detail-metric">
    <div class="detail-metric-label">Burned Area</div>
    <div class="detail-metric-val" id="detailBurned"></div>
  </div>
  <div class="detail-metric">
    <div class="detail-metric-label">Est. Events</div>
    <div class="detail-metric-val" id="detailEvents"></div>
  </div>
  <button class="close-btn" onclick="selectCountry(null)">&#x2715;</button>
</div>

<!-- AGCP Branded Footer -->
<div class="footer">
  <div class="footer-grid">
    <div class="footer-sources">
      Data: GWIS / MODIS MCD64A1 burned area product via Our World in Data &amp; GWIS Country Profiles.
      Estimated fire events from GlobFire spatiotemporal clustering. Values represent recent representative annual totals.
      <br>
      Sources: gwis.jrc.ec.europa.eu &middot; ourworldindata.org/grapher/annual-area-burnt-by-wildfires &middot; land.copernicus.eu
    </div>
    <div class="footer-prepared">
      <div class="prep-label">Prepared by</div>
      <div class="prep-company">AGCP Farmac&ecirc;uticos, LDA</div>
      <div class="prep-sub">Advanced Materials Platform &middot; Coimbra, Portugal</div>
    </div>
  </div>
  <div class="footer-legal">
    &copy; 2026 AGCP Farmac&ecirc;uticos, LDA. All rights reserved. This report is provided for informational purposes only.
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
<script>
const RAW = [
  { id: "024", name: "Angola", burned_ha: 79200000, events_est: 185000, peak: "Jun–Sep" },
  { id: "180", name: "DR Congo", burned_ha: 58500000, events_est: 142000, peak: "Jun–Sep" },
  { id: "508", name: "Mozambique", burned_ha: 35800000, events_est: 95000, peak: "Jul–Oct" },
  { id: "834", name: "Tanzania", burned_ha: 28900000, events_est: 78000, peak: "Jun–Oct" },
  { id: "894", name: "Zambia", burned_ha: 27500000, events_est: 72000, peak: "Jun–Oct" },
  { id: "076", name: "Brazil", burned_ha: 26100000, events_est: 68000, peak: "Jul–Oct" },
  { id: "854", name: "Burkina Faso", burned_ha: 10200000, events_est: 32000, peak: "Nov–Feb" },
  { id: "566", name: "Nigeria", burned_ha: 9800000, events_est: 28000, peak: "Nov–Mar" },
  { id: "710", name: "South Africa", burned_ha: 9500000, events_est: 26000, peak: "Jun–Oct" },
  { id: "800", name: "Uganda", burned_ha: 4200000, events_est: 15000, peak: "Dec–Mar" },
  { id: "862", name: "Venezuela", burned_ha: 4100000, events_est: 12000, peak: "Jan–Apr" },
  { id: "170", name: "Colombia", burned_ha: 3800000, events_est: 11000, peak: "Jan–Mar" },
  { id: "356", name: "India", burned_ha: 5600000, events_est: 42000, peak: "Feb–May" },
  { id: "104", name: "Myanmar", burned_ha: 5200000, events_est: 18000, peak: "Feb–Apr" },
  { id: "764", name: "Thailand", burned_ha: 3800000, events_est: 14000, peak: "Jan–Apr" },
  { id: "418", name: "Laos", burned_ha: 2900000, events_est: 9500, peak: "Feb–Apr" },
  { id: "116", name: "Cambodia", burned_ha: 2400000, events_est: 8500, peak: "Jan–Apr" },
  { id: "360", name: "Indonesia", burned_ha: 3200000, events_est: 12000, peak: "Aug–Oct" },
  { id: "036", name: "Australia", burned_ha: 52000000, events_est: 62000, peak: "Oct–Mar" },
  { id: "643", name: "Russia", burned_ha: 18500000, events_est: 35000, peak: "Apr–Sep" },
  { id: "840", name: "United States", burned_ha: 3100000, events_est: 58000, peak: "Jun–Oct" },
  { id: "124", name: "Canada", burned_ha: 6500000, events_est: 7200, peak: "May–Sep" },
  { id: "032", name: "Argentina", burned_ha: 4500000, events_est: 9800, peak: "Aug–Nov" },
  { id: "068", name: "Bolivia", burned_ha: 6200000, events_est: 14000, peak: "Jul–Oct" },
  { id: "600", name: "Paraguay", burned_ha: 3800000, events_est: 8500, peak: "Aug–Oct" },
  { id: "404", name: "Kenya", burned_ha: 4800000, events_est: 12000, peak: "Jan–Mar" },
  { id: "148", name: "Chad", burned_ha: 12500000, events_est: 38000, peak: "Oct–Feb" },
  { id: "140", name: "Central African Rep.", burned_ha: 18200000, events_est: 52000, peak: "Nov–Mar" },
  { id: "686", name: "Senegal", burned_ha: 3200000, events_est: 11000, peak: "Nov–Feb" },
  { id: "466", name: "Mali", burned_ha: 8500000, events_est: 28000, peak: "Oct–Feb" },
  { id: "288", name: "Ghana", burned_ha: 3800000, events_est: 12000, peak: "Nov–Feb" },
  { id: "384", name: "Côte d'Ivoire", burned_ha: 5200000, events_est: 16000, peak: "Nov–Feb" },
  { id: "324", name: "Guinea", burned_ha: 6800000, events_est: 22000, peak: "Nov–Mar" },
  { id: "516", name: "Namibia", burned_ha: 6200000, events_est: 8500, peak: "Jul–Oct" },
  { id: "072", name: "Botswana", burned_ha: 5500000, events_est: 7200, peak: "Jul–Oct" },
  { id: "716", name: "Zimbabwe", burned_ha: 6800000, events_est: 18000, peak: "Jul–Oct" },
  { id: "454", name: "Malawi", burned_ha: 3200000, events_est: 9500, peak: "Jul–Oct" },
  { id: "450", name: "Madagascar", burned_ha: 4500000, events_est: 14000, peak: "Aug–Nov" },
  { id: "620", name: "Portugal", burned_ha: 145000, events_est: 8200, peak: "Jun–Sep" },
  { id: "724", name: "Spain", burned_ha: 98000, events_est: 9800, peak: "Jun–Sep" },
  { id: "300", name: "Greece", burned_ha: 175000, events_est: 5200, peak: "Jun–Sep" },
  { id: "792", name: "Turkey", burned_ha: 280000, events_est: 4500, peak: "Jun–Sep" },
  { id: "380", name: "Italy", burned_ha: 72000, events_est: 5800, peak: "Jun–Sep" },
  { id: "250", name: "France", burned_ha: 68000, events_est: 4200, peak: "Jun–Aug" },
  { id: "276", name: "Germany", burned_ha: 4500, events_est: 1200, peak: "Apr–Aug" },
  { id: "826", name: "United Kingdom", burned_ha: 38000, events_est: 3200, peak: "Mar–Jun" },
  { id: "156", name: "China", burned_ha: 1200000, events_est: 8500, peak: "Feb–May" },
  { id: "496", name: "Mongolia", burned_ha: 2100000, events_est: 3200, peak: "Mar–May" },
  { id: "398", name: "Kazakhstan", burned_ha: 2800000, events_est: 4500, peak: "Apr–Sep" },
  { id: "484", name: "Mexico", burned_ha: 2800000, events_est: 8500, peak: "Mar–Jun" },
  { id: "604", name: "Peru", burned_ha: 1200000, events_est: 5500, peak: "Jul–Nov" },
  { id: "152", name: "Chile", burned_ha: 420000, events_est: 6200, peak: "Dec–Mar" },
  { id: "012", name: "Algeria", burned_ha: 95000, events_est: 3800, peak: "Jun–Sep" },
  { id: "804", name: "Ukraine", burned_ha: 420000, events_est: 12000, peak: "Mar–Sep" },
  { id: "562", name: "Niger", burned_ha: 5200000, events_est: 18000, peak: "Oct–Feb" },
  { id: "231", name: "Ethiopia", burned_ha: 4200000, events_est: 15000, peak: "Nov–Mar" },
  { id: "706", name: "Somalia", burned_ha: 2100000, events_est: 5200, peak: "Dec–Feb" },
  { id: "736", name: "Sudan", burned_ha: 12800000, events_est: 42000, peak: "Oct–Mar" },
  { id: "728", name: "South Sudan", burned_ha: 14500000, events_est: 48000, peak: "Nov–Mar" },
  { id: "120", name: "Cameroon", burned_ha: 5800000, events_est: 18000, peak: "Nov–Feb" },
  { id: "178", name: "Congo", burned_ha: 8500000, events_est: 28000, peak: "Jun–Sep" },
  { id: "266", name: "Gabon", burned_ha: 1200000, events_est: 4500, peak: "Jun–Sep" },
  { id: "204", name: "Benin", burned_ha: 3200000, events_est: 12000, peak: "Nov–Feb" },
  { id: "768", name: "Togo", burned_ha: 1800000, events_est: 8500, peak: "Nov–Feb" },
  { id: "694", name: "Sierra Leone", burned_ha: 2800000, events_est: 9500, peak: "Nov–Mar" },
  { id: "430", name: "Liberia", burned_ha: 2200000, events_est: 7500, peak: "Dec–Mar" },
  { id: "624", name: "Guinea-Bissau", burned_ha: 1200000, events_est: 5200, peak: "Nov–Feb" },
  { id: "608", name: "Philippines", burned_ha: 380000, events_est: 5200, peak: "Mar–May" },
  { id: "704", name: "Vietnam", burned_ha: 420000, events_est: 4800, peak: "Feb–Apr" },
  { id: "458", name: "Malaysia", burned_ha: 180000, events_est: 2800, peak: "Feb–Apr" },
  { id: "554", name: "New Zealand", burned_ha: 8500, events_est: 4200, peak: "Dec–Mar" },
  { id: "598", name: "Papua New Guinea", burned_ha: 1800000, events_est: 5500, peak: "Aug–Nov" },
  { id: "646", name: "Rwanda", burned_ha: 420000, events_est: 2800, peak: "Jun–Sep" },
  { id: "050", name: "Bangladesh", burned_ha: 180000, events_est: 1200, peak: "Feb–Apr" },
  { id: "270", name: "Gambia", burned_ha: 280000, events_est: 1800, peak: "Nov–Feb" },
  { id: "320", name: "Guatemala", burned_ha: 420000, events_est: 3200, peak: "Mar–May" },
  { id: "340", name: "Honduras", burned_ha: 580000, events_est: 4200, peak: "Mar–May" },
  { id: "558", name: "Nicaragua", burned_ha: 380000, events_est: 2800, peak: "Mar–May" },
  { id: "586", name: "Pakistan", burned_ha: 280000, events_est: 3500, peak: "May–Jul" },
  { id: "364", name: "Iran", burned_ha: 180000, events_est: 2200, peak: "Jun–Sep" },
  { id: "108", name: "Burundi", burned_ha: 280000, events_est: 2200, peak: "Jun–Sep" },
  { id: "232", name: "Eritrea", burned_ha: 520000, events_est: 3200, peak: "Dec–Mar" },
  { id: "616", name: "Poland", burned_ha: 6500, events_est: 4200, peak: "Apr–Aug" },
  { id: "752", name: "Sweden", burned_ha: 5500, events_est: 4200, peak: "May–Aug" },
  { id: "642", name: "Romania", burned_ha: 28000, events_est: 1500, peak: "Mar–Sep" },
  { id: "100", name: "Bulgaria", burned_ha: 32000, events_est: 1200, peak: "Jun–Sep" },
  { id: "191", name: "Croatia", burned_ha: 18000, events_est: 850, peak: "Jun–Sep" },
  { id: "504", name: "Morocco", burned_ha: 12000, events_est: 980, peak: "Jun–Sep" },
  { id: "858", name: "Uruguay", burned_ha: 95000, events_est: 1500, peak: "Jan–Mar" },
  { id: "218", name: "Ecuador", burned_ha: 68000, events_est: 2800, peak: "Aug–Nov" },
  { id: "192", name: "Cuba", burned_ha: 85000, events_est: 1800, peak: "Mar–May" },
  { id: "410", name: "South Korea", burned_ha: 12000, events_est: 480, peak: "Mar–May" },
  { id: "392", name: "Japan", burned_ha: 2800, events_est: 1800, peak: "Mar–May" },
  { id: "372", name: "Ireland", burned_ha: 12000, events_est: 850, peak: "Mar–Jun" },
];

const DATA_MAP = {};
RAW.forEach(d => { if (!DATA_MAP[d.id] || d.burned_ha > DATA_MAP[d.id].burned_ha) DATA_MAP[d.id] = d; });

let currentMetric = "burned_ha";
let selectedId = null;
let hoveredId = null;
let geoFeatures = [];

function fmt(n) { return n >= 1e6 ? (n/1e6).toFixed(1)+"M" : n >= 1e3 ? (n/1e3).toFixed(1)+"K" : n.toLocaleString(); }
function fmtHa(n) { return n >= 1e6 ? (n/1e6).toFixed(1)+"M ha" : n >= 1e3 ? Math.round(n/1e3)+"K ha" : n.toLocaleString()+" ha"; }

function makeColorScale() {
  const vals = Object.values(DATA_MAP).map(d => d[currentMetric]).filter(Boolean);
  const mx = d3.max(vals);
  return d3.scaleSequential()
    .domain([0, Math.log10(mx + 1)])
    .interpolator(d3.interpolateRgbBasis([
      "#1a1a2e","#2d1b3d","#4a1942","#6b1d2a",
      "#8b2500","#b33a00","#d4560e","#e8751a",
      "#f09428","#f5b942","#fad666","#fff3b0"
    ]));
}

function getColor(id, cs) {
  const d = DATA_MAP[id]; if (!d) return "#0d1118";
  const v = d[currentMetric]; if (!v) return "#0d1118";
  return cs(Math.log10(v + 1));
}

async function init() {
  const vals = Object.values(DATA_MAP);
  const totalBurned = vals.reduce((s,d) => s + (d.burned_ha||0), 0);
  const totalEvents = vals.reduce((s,d) => s + (d.events_est||0), 0);
  document.getElementById("statsRow").innerHTML = [
    { l: "Total Burned Area", v: fmtHa(totalBurned) },
    { l: "Estimated Fire Events", v: fmt(totalEvents) },
    { l: "Countries Affected", v: vals.length },
  ].map(s => `<div><div class="stat-label">${s.l}</div><div class="stat-value">${s.v}</div></div>`).join("");

  const resp = await fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json");
  const topo = await resp.json();
  geoFeatures = topojson.feature(topo, topo.objects.countries).features;

  renderMap();
  renderRanking();
  renderLegend();
}

function renderMap() {
  const svg = d3.select("#mapSvg");
  svg.selectAll("*").remove();
  const proj = d3.geoNaturalEarth1().scale(165).translate([480, 260]);
  const path = d3.geoPath().projection(proj);
  const cs = makeColorScale();

  svg.append("path").datum(d3.geoGraticule10())
    .attr("d", path).attr("fill", "none").attr("stroke", "rgba(255,255,255,0.03)").attr("stroke-width", 0.3);

  svg.selectAll(".country-path")
    .data(geoFeatures).join("path")
    .attr("class", d => "country-path" + (DATA_MAP[String(d.id).padStart(3,"0")] ? " has-data" : ""))
    .attr("d", path)
    .attr("fill", d => getColor(String(d.id).padStart(3,"0"), cs))
    .attr("stroke", "rgba(255,255,255,0.06)").attr("stroke-width", 0.3)
    .on("mouseenter", function(e, d) {
      const id = String(d.id).padStart(3,"0");
      if (!DATA_MAP[id]) return;
      hoveredId = id;
      d3.select(this).attr("stroke", "#00a484").attr("stroke-width", 1.5).style("filter", "brightness(1.3)");
      showTooltip(id, e);
    })
    .on("mousemove", function(e) { moveTooltip(e); })
    .on("mouseleave", function() {
      hoveredId = null;
      d3.select(this).attr("stroke", "rgba(255,255,255,0.06)").attr("stroke-width", 0.3).style("filter", "none");
      hideTooltip();
    })
    .on("click", function(e, d) {
      const id = String(d.id).padStart(3,"0");
      if (!DATA_MAP[id]) return;
      selectCountry(selectedId === id ? null : id);
    });

  svg.append("path").datum({type:"Sphere"})
    .attr("d", path).attr("fill","none").attr("stroke","rgba(255,255,255,0.08)").attr("stroke-width",0.5);
}

function renderLegend() {
  const cs = makeColorScale();
  const vals = Object.values(DATA_MAP).map(d => d[currentMetric]).filter(Boolean);
  const mx = d3.max(vals);
  const label = currentMetric === "burned_ha" ? "BURNED AREA" : "FIRE EVENTS";
  let html = `<span class="legend-label">${label} ▸</span><div class="legend-bar">`;
  for (let i = 0; i < 40; i++) {
    const t = (i / 39) * Math.log10(mx + 1);
    html += `<div style="background:${cs(t)}"></div>`;
  }
  html += `</div><span class="legend-range">LOW → HIGH (log scale)</span>`;
  document.getElementById("legend").innerHTML = html;
}

function renderRanking() {
  const label = currentMetric === "burned_ha" ? "Burned Area" : "Events";
  document.getElementById("sidebarTitle").textContent = `Top 15 by ${label}`;
  const top = Object.values(DATA_MAP).sort((a,b) => b[currentMetric] - a[currentMetric]).slice(0, 15);
  const maxVal = top[0][currentMetric];
  document.getElementById("rankList").innerHTML = top.map((c, i) => {
    const pct = (c[currentMetric] / maxVal) * 100;
    const sel = selectedId === c.id ? " selected" : "";
    const val = currentMetric === "burned_ha" ? fmtHa(c[currentMetric]) : fmt(c[currentMetric]);
    return `<div class="rank-item${sel}" data-id="${c.id}"
      onmouseenter="highlightCountry('${c.id}')" onmouseleave="unhighlightCountry('${c.id}')"
      onclick="selectCountry(selectedId==='${c.id}'?null:'${c.id}')">
      <div class="rank-bar" style="width:${pct}%"></div>
      <div class="rank-content">
        <div style="display:flex;align-items:center"><span class="rank-num">${i+1}</span><span class="rank-name">${c.name}</span></div>
        <span class="rank-val">${val}</span>
      </div>
    </div>`;
  }).join("");
}

function highlightCountry(id) {
  hoveredId = id;
  d3.selectAll(".country-path").each(function(d) {
    if (String(d.id).padStart(3,"0") === id)
      d3.select(this).attr("stroke", "#00a484").attr("stroke-width", 1.5).style("filter", "brightness(1.3)");
  });
}
function unhighlightCountry(id) {
  hoveredId = null;
  d3.selectAll(".country-path").each(function(d) {
    if (String(d.id).padStart(3,"0") === id)
      d3.select(this).attr("stroke", "rgba(255,255,255,0.06)").attr("stroke-width", 0.3).style("filter", "none");
  });
}

function showTooltip(id, e) {
  const d = DATA_MAP[id]; if (!d) return;
  document.getElementById("tipName").textContent = d.name;
  document.getElementById("tipBurned").textContent = fmtHa(d.burned_ha);
  document.getElementById("tipEvents").textContent = fmt(d.events_est);
  document.getElementById("tipPeak").textContent = d.peak;
  document.getElementById("tooltip").classList.add("visible");
  moveTooltip(e);
}
function moveTooltip(e) {
  const tip = document.getElementById("tooltip");
  const rect = document.getElementById("mapContainer").getBoundingClientRect();
  tip.style.left = (e.clientX - rect.left + 16) + "px";
  tip.style.top = (e.clientY - rect.top - 10) + "px";
}
function hideTooltip() { document.getElementById("tooltip").classList.remove("visible"); }

function selectCountry(id) {
  selectedId = id;
  const card = document.getElementById("detailCard");
  if (!id || !DATA_MAP[id]) { card.classList.remove("visible"); renderRanking(); return; }
  const d = DATA_MAP[id];
  document.getElementById("detailName").textContent = d.name;
  document.getElementById("detailPeak").textContent = "Peak Season: " + d.peak;
  document.getElementById("detailBurned").textContent = fmtHa(d.burned_ha);
  document.getElementById("detailEvents").textContent = fmt(d.events_est);
  card.classList.add("visible");
  renderRanking();
}

function setMetric(m) {
  currentMetric = m;
  document.querySelectorAll(".metric-btn").forEach(b => b.classList.toggle("active", b.dataset.metric === m));
  renderMap(); renderRanking(); renderLegend();
}

init();
</script>
</body>
</html>
